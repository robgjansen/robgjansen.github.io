





<!doctype html>
<html lang="en" class="no-js">
  <head>
    





<meta charset="utf-8">







<!-- begin SEO -->









<title>New Foundations for Tor Network Experimentation - robgjansen.com</title>







<meta property="og:locale" content="en">
<meta property="og:site_name" content="robgjansen.com">
<meta property="og:title" content="New Foundations for Tor Network Experimentation">




  <meta property="og:description" content="  This post originally appeared on the TorProject blog.">





  

  





  <meta property="og:type" content="article">
  <meta property="article:published_time" content="2022-04-02T12:47:38-04:00">








  <script type="application/ld+json">
    {
      "@context" : "http://schema.org",
      "@type" : "Person",
      "name" : "Rob G. Jansen",
      "url" : null,
      "sameAs" : null
    }
  </script>






<!-- end SEO -->


<link href="/feed.xml" type="application/atom+xml" rel="alternate" title="robgjansen.com Feed">

<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">
<link rel="stylesheet" href="/assets/css/academicons.min.css"/>

<meta http-equiv="cleartype" content="on">

    <!-- start custom head snippets -->

<!-- insert favicons. use http://realfavicongenerator.net/ -->

<!-- end custom head snippets -->
  </head>

  <body>

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->
    





<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        <button><div class="navicon"></div></button>
        <ul class="visible-links">
          <li class="masthead__menu-item masthead__menu-item--lg"><a href="/">robgjansen.com</a></li>
          
            
            <li class="masthead__menu-item"><a href="/bio">Bio</a></li>
          
            
            <li class="masthead__menu-item"><a href="/publications">Publications</a></li>
          
            
            <li class="masthead__menu-item"><a href="/talks">Talks</a></li>
          
            
            <li class="masthead__menu-item"><a href="/service">Service</a></li>
          
            
            <li class="masthead__menu-item"><a href="/blog">Blog</a></li>
          
        </ul>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>

    









<div id="main" role="main">
  






  <div class="sidebar sticky">
  







<div itemscope itemtype="http://schema.org/Person">

  <div class="author__avatar">
    
    	<img src="/images/rob2.jpg" class="author__avatar" alt="Rob G. Jansen">
    
  </div>

  <div class="author__content">
    <h3 class="author__name">Rob G. Jansen, Ph.D.</h3>
    <p class="author__bio">Computer Security Research Scientist at the U.S. Naval Research Laboratory<br/><br/>Research interests include: distributed system security, privacy-enhancing technologies, and parallel and distributed simulation</p>
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">Follow</button>
    <ul class="author__urls social-icons">
      
        <li><i class="fa fa-fw fa-map-marker" aria-hidden="true"></i> Washington, DC, USA</li>
      
      
      
        <li><a href="mailto:rob.g.jansen@nrl.navy.mil"><i class="fa fa-fw fa-envelope-square" aria-hidden="true"></i> Email</a></li>
      
      
      
        <li><a href="https://scholar.google.com/citations?user=_s3Lx1oAAAAJ"><i class="fa fa-fw ai ai-google-scholar-square" aria-hidden="true"></i> Google Scholar</a></li>
      
      
        <li><a href="https://github.com/robgjansen"><i class="fa fa-fw fa-github" aria-hidden="true"></i> Github</a></li>
      
      
        <li><a href="https://twitter.com/robgjansen"><i class="fa fa-fw fa-twitter-square" aria-hidden="true"></i> Twitter</a></li>
      
      
      
      
      
      
      
      
      
      
      
      
      
      
        <li><a href="https://www.youtube.com/user/robgjansen"><i class="fa fa-fw fa-youtube-square" aria-hidden="true"></i> YouTube</a></li>
      
      
        <li><a href="https://www.linkedin.com/in/robgjansen"><i class="fa fa-fw fa-linkedin-square" aria-hidden="true"></i> LinkedIn</a></li>
      
      
      
      
      
      
    </ul>
  </div>
</div>

  
  </div>


  <article class="page" itemscope itemtype="http://schema.org/CreativeWork">
    <meta itemprop="headline" content="New Foundations for Tor Network Experimentation">
    <meta itemprop="description" content="  This post originally appeared on the TorProject blog.">
    <meta itemprop="datePublished" content="April 02, 2022">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 class="page__title" itemprop="headline">New Foundations for Tor Network Experimentation
</h1>
          
  

  
  <p class="page__meta">
    <i class="fa fa-user" aria-hidden="true"></i> Rob G. Jansen
    
    &nbsp;
    <i class="fa fa-fw fa-calendar" aria-hidden="true"></i> <time datetime="2022-04-02T12:47:38-04:00">April 02, 2022</time>
    
    
    &nbsp;
    <i class="fa fa-clock-o" aria-hidden="true"></i> 


  
	  9 minute read
	

    
  </p>
  


        </header>
      

      <section class="page__content" itemprop="text">
        <blockquote>
  <p>This post originally appeared <a href="https://blog.torproject.org/new-foundations-tor-network-experimentation/">on the TorProject blog</a>.</p>
</blockquote>

<p>Hello, Tor World!</p>

<p>Justin Tracey, Ian Goldberg, and I (<a href="https://www.robgjansen.com/">Rob Jansen</a>) recently published some work that makes it easier to run Tor network experiments under simulation and helps us do a better job of quantifying confidence in simulation results. This post offers some background and a high-level summary of our scientific publication:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>Once is Never Enough: Foundations for Sound Statistical Inference in Tor Network Experimentation
30th USENIX Security Symposium (Sec 2021)
Rob Jansen, Justin Tracey, and Ian Goldberg
</code></pre>
</div>

<p>The <a href="https://www.usenix.org/conference/usenixsecurity21/presentation/jansen">research article, video presentation, and slides are available online</a>, and we’ve also published our <a href="https://neverenough-sec2021.github.io/">research artifacts</a>.</p>

<p>If you don’t want to read the entire post (which provides more background and context), here are the main points that we hope you will take away from our work:</p>

<ul>
  <li><strong>Better Models and Tools</strong>:
    <ul>
      <li><em>Contribution</em>: We improved modeling and simulation tools to produce Tor test networks that are more representative of the live Tor network and that we can simulate faster and at larger scales than were previously possible.</li>
      <li><em>Outcome</em>: We achieved a significant new milestone: we ran simulations with 6,489 relays and 792k simultaneously active users, the largest known Tor network simulations and the first at a network scale of 100%.</li>
    </ul>
  </li>
  <li><strong>New Statistical Methodologies</strong>:
    <ul>
      <li><em>Contribution</em>: We established a new methodology for employing statistical inference to quantify test network sampling error and make more useful predictions from test networks.</li>
      <li><em>Outcomes</em>: We find that (1) running multiple simulations in independently sampled Tor test networks is necessary to draw statistically significant conclusions, and (2) larger-scale test networks require fewer repeated trials than smaller-scale test networks to reach the same level of confidence in the results.</li>
    </ul>
  </li>
</ul>

<p>More details are below!</p>

<h1 id="background-tor-network-experiments">Background: Tor Network Experiments</h1>

<p>Network experimentation is of vital importance to the Tor Project’s research, development, and deployment processes. Experiments help us understand and estimate the viability of new research ideas, to test out newly written code, and to measure the real world effects of new features. Measurements taken during experiments help us gain confidence that Tor is working how we expect it should be.</p>

<p>Experiments are often run directly on the live, public Tor network—the one to which we all connect when we use Tor Browser. Live network experiments are possible when production-ready code is available and deployed through standard Tor software updates, or when code needs to be deployed on only a small number of nodes. Live network experiments allow us to gather, analyze, and assess information that is most relevant the target, real-world network environment. (We maintain a <a href="https://status.torproject.org/affected/network-experiments">list of ongoing and recent live network experiments</a> from those who notify us.)</p>

<p>However, live network experiments carry additional, sometimes significant risk to the safety and privacy of Tor users and should be avoided whenever possible. As outlined by our <a href="https://research.torproject.org/safetyboard">Research Safety Board</a>, we should use a private, test Tor network to conduct experiments whenever possible. Test networks such as those that are run in <a href="https://github.com/shadow/shadow">the Shadow network simulator</a> are completely private and segregated from the Internet, providing an environment in which we can run Tor experiments with absolutely no safety or privacy risks. Test networks should be our only choice when evaluating attacks or other experiments that are otherwise unethical to run.</p>

<p>Private test networks have many important advantages in addition to the safety and privacy benefits they offer:</p>

<ul>
  <li>Test networks can help us more quickly test and debug new code during the development process. Even the best programmers in the world can occasionally introduce a bug that is not covered by more conventional unit or integration testing. Running a larger and more diverse test network can help us exercise complex corner cases and improve test coverage.</li>
  <li>Test networks allow us to immediately deploy new code across the entire private network of Tor relays and clients without having to wait for lengthy deployment cycles. (If you <a href="https://community.torproject.org/relay">run a Tor relay</a>, thank you! and please keep it up to date.) Immediate deployment in test networks not only helps us tighten the development cycle and tune parameters, but also increases our confidence that things will work as expected when the code is deployed to the live network.</li>
  <li>Test networks allow the community to more quickly design and evaluate novel research ideas (e.g., a performance enhancing algorithm or protocol) using prototypes without committing the time and effort that would be required to produce production-quality code. This allows us to more quickly learn about and identify design changes that are worth the additional development, deployment, and maintenance costs.</li>
</ul>

<h1 id="more-realistic-tor-test-networks">More Realistic Tor Test Networks</h1>

<h2 id="modeling">Modeling</h2>

<p>We want to ensure that Tor test networks that operate independently of the live Tor network still produce results that are relevant to the real world. The first Tor test network models were published about 10 years ago using network data published by <a href="https://metrics.torproject.org/">Tor metrics</a>, and our methodology has continued to improve over the years thanks to new privacy-preserving measurement systems (<a href="https://cypherpunks.ca/~iang/pubs/privex-ccs14.pdf">PrivEx</a> and <a href="https://www.robgjansen.com/blog/2016/10/23/introducing-privcount-for-safely-measuring-tor/">PrivCount</a>) and new privacy-preserving measurement studies of Tor <a href="https://torusage-imc2018.github.io/">network composition</a> and <a href="https://tmodel-ccs2018.github.io/">background traffic</a>. These works have enabled us to create private Tor test networks whose characteristics are increasingly similar to those of the live Tor network.</p>

<p>We further advance Tor network modeling in our work. We designed a new network modeling approach that (1) can synthesize the state of the Tor network over time (rather than modeling a static point in time), and (2) can use a small number of background traffic generator processes to accurately simulate the traffic from a much large number of Tor users (reducing the computing resources required to run an experiment). With these changes, we can now produce Tor test networks that are more representative than those used in previous work.</p>

<h2 id="performance">Performance</h2>

<p>In the live Tor network, thousands of relays forward hundreds of Gbit/s of traffic from hundreds of thousands of users at an average point in time. Accurately reproducing the associated traffic properties in a test network requires a significant amount of computing resources. As a result, it has become standard practice for researchers to down-sample relays and create a smaller-scale Tor network that could be run with fewer computing resources. However, as we’ll show in the next section, we find that smaller-scale test networks are less representative of the live Tor network and we have significantly less confidence in the results they produce. Therefore, it is beneficial to have more efficient tools that use fewer resources to run a simulation and that allow us to run larger-scale simulations.</p>

<p>After conducting a performance audit of Shadow, the tool we use to run Tor test network experiments, we implemented several accuracy and performance improvements that were merged into Shadow v1.13.2. Our improvements enable us to run Tor simulations faster and at larger scales than were previously possible. With our modeling and performance improvements, we achieved a significant new milestone: we ran simulations with 6,489 relays and 792k simultaneously active users, the largest known Tor network simulations and the first at a network scale of 100%. (Please note that these experiments required a machine with ~4TB of RAM to complete, but we think <a href="https://github.com/shadow/shadow/issues/1717">ongoing work</a> could reduce this by a 10x factor.)</p>

<h2 id="improving-our-confidence-in-test-network-results">Improving Our Confidence in Test Network Results</h2>

<p>A critical but understudied component of Tor network modeling is how the scale of the test network affects our confidence in the results it produces. Due in part to performance and resource limitations, researchers have usually run a single experimental trial in a scaled-down Tor test network. Because test networks are sampled using data from the live Tor network, there is an associated sampling error that must be quantified when making predictions about how the effects observed in sampled Tor networks generalize to the live Tor network. However, the standard practice was to ignore this sampling error.</p>

<p>In our work, we establish a new methodology for employing statistical inference to quantify the sampling error and to guide us toward making more useful predictions from sampled test network. Our methodology employs repeated sampling and confidence intervals (CIs) to establish the precision of estimations that are made across sampled networks. CIs are a statistical tool to help us do better science; they allow us to make a statistical argument about the extent to which the simulation results are (or are not) relevant to the real world. In particular, CIs help guide us to sample additional Tor networks (and run additional experiment trials) if additional precision is necessary to confirm or reject a research hypothesis.</p>

<p>We conducted a case study on Tor usage and performance to demonstrate how to apply our methodology to a concrete set of experiments. We considered whether adding 20% of additional load to the Tor network would reduce performance–we certainly expect that it should!</p>

<p><img src="https://neverenough-sec2021.github.io/performance_analysis/figure7a.pdf" alt="image-center" class="align-center" width="500" />
<em>Figure 7a: Benchmark performance with traffic load ℓ=1.0 and ℓ=1.2 at a 1% network scale.</em></p>

<p>Figure 7a plots the results of applying our statistical inference methodology to 1% scaled-down test networks in which we ran n={10,100} trials with network loads of ℓ={1.0,1.2} times the normal load. We can see that there is considerable overlap in the CIs, even when running n=100 repeated trials. In fact, this graph indicates that adding 20% additional load to the network reduces the time to download files, i.e., makes the network faster–the opposite of the outcome that we expected!</p>

<p><img src="https://neverenough-sec2021.github.io/performance_analysis/figure7b.pdf" alt="image-center" class="align-center" width="500" />
<em>Figure 7b: Benchmark performance with traffic load ℓ=1.0 and ℓ=1.2 at a 10% network scale.</em></p>

<p>Figure 7b plots the results of applying our statistical inference methodology to much larger 10% scaled-down test networks in which we ran n={5,10,100} trials with network loads of ℓ={1.0,1.2} times the standard load. Here we see that when running only n=5 trials, there is some separation between the CIs but still some overlap in the lower 80% of the distribution. However, running more trials produces more precise (narrower) CIs that increase our confidence in our hypothesis that adding 20% additional load to the network does in fact increase the time to download files.</p>

<p>We conclude from our case study on Tor usage and performance that (1) running multiple simulations in independently sampled Tor test networks is necessary to draw statistically significant conclusions, and (2) that fewer simulations are generally needed to achieve a desired CI precision in test networks of larger scale than in those of smaller scale.</p>

<p>An important takeaway is that our work demonstrates a methodology that those of us running Tor experiments in test networks can now follow in order to (1) estimate the extent to which our experimental results are scientifically meaningful, and (2) guide us toward producing more statistically rigorous conclusions.</p>

<h1 id="availability">Availability</h1>

<p>Our methods and tools have been contributed to the open source community. If you’re interested in taking advantage of our work, a good place to start is by first <a href="https://shadow.github.io/docs/guide">setting up Shadow</a>, and then <a href="https://github.com/shadow/tornettools">tornettools</a> will help guide you through the process of creating Tor test networks, running simulations, and processing results. You can ask questions on <a href="https://github.com/shadow/shadow/discussions">Shadow’s discussion page</a>.</p>

<h1 id="practical-applications-of-our-work">Practical Applications of Our Work</h1>

<p>The Shadow team has adopted our tools as part of their automated, continuous integration tests which now include <a href="https://github.com/shadow/shadow/actions/workflows/run_tor.yml">testing in private Tor test networks</a>.</p>

<p>The core Tor network team has been building upon our contributions as they develop, test, and tune a new set of congestion control protocols that will begin to roll out in the coming months. Our work has helped them more rapidly prepare test network environments and more thoroughly explore the design space while tuning parameters. For more information, see <a href="https://gitlab.torproject.org/tpo/core/tor/-/issues/40404">the GitLab tracking issue</a>, the <a href="https://gitlab.torproject.org/tpo/core/torspec/-/blob/master/proposals/324-rtt-congestion-control.txt">congestion control proposal</a>, and <a href="https://gitlab.torproject.org/mikeperry/tor/-/blob/cc_shadow_experiments_v2/SHADOW_EXPERIMENTS.txt">the Shadow congestion control experiment plan</a>.</p>

<p>Thanks for reading!</p>

<p>All the best, ~Rob</p>

<p>[Thanks to Ian Goldberg and Justin Tracey for input on this post!]</p>

        
      </section>

      <footer class="page__meta">
        

        






  








  
  
  

  <p class="page__taxonomy">
    <strong><i class="fa fa-fw fa-tags" aria-hidden="true"></i> Tags: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="/blog/experimentation" class="page__taxonomy-item" rel="tag">experimentation</a><span class="sep">, </span>
    
      
      
      <a href="/blog/shadow" class="page__taxonomy-item" rel="tag">shadow</a><span class="sep">, </span>
    
      
      
      <a href="/blog/simulation" class="page__taxonomy-item" rel="tag">simulation</a><span class="sep">, </span>
    
      
      
      <a href="/blog/tor" class="page__taxonomy-item" rel="tag">tor</a>
    
    </span>
  </p>




  








  
  
  

  <p class="page__taxonomy">
    <strong><i class="fa fa-fw fa-folder-open" aria-hidden="true"></i> Categories: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="/blog/research" class="page__taxonomy-item" rel="tag">research</a>
    
    </span>
  </p>




        
        <p class="page__date"><strong><i class="fa fa-fw fa-calendar" aria-hidden="true"></i> Posted:</strong> <time datetime="2022-04-02T12:47:38-04:00">April 02 </time><a href="/blog/2022" class="page__taxonomy-item" rel="year">2022</a>
        

        
      </footer>

      

      






  <nav class="pagination">
    
      <a href="/blog/2016/10/23/introducing-privcount-for-safely-measuring-tor/" class="pagination--pager" title="Introducing PrivCount, a Distributed System for Safely Measuring Tor
">Previous</a>
    
    
      <a href="#" class="pagination--pager disabled">Next</a>
    
  </nav>

    </div>

    
      





<div class="page__comments">
  
  
    <h4 class="page__comments-title">Leave a Comment</h4>
    <section id="disqus_thread"></section>
  
</div>
    
  </article>

  
  
</div>


    <div class="page__footer">
      <footer>
        





<div class="page__footer-follow">
  <ul class="social-icons">
    
      <li><strong>Follow:</strong></li>
    
    
    
    
      <li><a href="http://github.com/robgjansen"><i class="fa fa-fw fa-github" aria-hidden="true"></i> GitHub</a></li>
    
    
    <li><a href="/feed.xml"><i class="fa fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2022 Rob G. Jansen. Powered by <a href="http://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>
        <!-- start custom footer snippets -->
<div class="page__footer-custom">
The views and opinions expressed in this page are strictly those of the page author.
</div>
<!-- end custom footer snippets -->

      </footer>
    </div>

    <script src="/assets/js/main.min.js"></script>




  <script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-18979348-2']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>






  
  <script type="text/javascript">
  	/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
  	var disqus_shortname = 'robgjansen-website';

  	/* * * DON'T EDIT BELOW THIS LINE * * */
  	(function() {
  		var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
  		dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  		(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  	})();

  	/* * * DON'T EDIT BELOW THIS LINE * * */
  	(function () {
  		var s = document.createElement('script'); s.async = true;
  		s.type = 'text/javascript';
  		s.src = '//' + disqus_shortname + '.disqus.com/count.js';
  		(document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
  	}());
  </script>
  <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>






  </body>
</html>

